<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>회원가입</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.error-message {
			font-size: 0.9em;
			color: red;
			display: none;
		}

		.reset-link {
			font-size: 0.9em;
			color: #6c757d;
			display: block;
			text-align: center;
			margin: 10px 0;
		}
	</style>
</head>

<body class="bg-light">
	<div class="container mt-5">
		<div class="row justify-content-center">
			<div class="col-md-5">
				<div class="card shadow-lg">
					<div class="card-header text-center bg-primary text-white">
						<h4 class="mb-0">회원가입</h4>
					</div>
					<div class="card-body">
						<form id="signupForm" action="/signup" method="post">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							<!-- 이메일 입력 -->
							<div class="mb-3">
								<label for="email" class="form-label">이메일</label>
								<input type="text" class="form-control" id="email" name="email"
									placeholder="이메일을 입력하세요">
								<div class="error-message" id="emailError">이메일을 입력해주세요.</div>
							</div>

							<!-- 비밀번호 입력 -->
							<div class="mb-3">
								<label for="password" class="form-label">비밀번호</label>
								<input type="password" class="form-control" id="password" name="password"
									placeholder="비밀번호를 입력하세요">
								<div class="error-message" id="passwordError">
									비밀번호는 8자 이상, 대문자 1개 이상, 특수기호를 포함해야 합니다.
								</div>
							</div>

							<!-- 비밀번호 확인 -->
							<div class="mb-4">
								<label for="confirmPassword" class="form-label">비밀번호 확인</label>
								<input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
									placeholder="비밀번호를 다시 입력하세요">
								<div class="error-message" id="confirmPasswordError">비밀번호가 일치하지 않습니다.</div>
							</div>

							<!-- 가입 버튼 -->
							<div class="d-grid">
								<button type="submit" class="btn btn-primary">이메일로 가입하기</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 유효성 검사 JS -->
	<script>
		const emailInput = document.getElementById('email');
		const passwordInput = document.getElementById('password');
		const confirmPasswordInput = document.getElementById('confirmPassword');

		const emailError = document.getElementById('emailError');
		const passwordError = document.getElementById('passwordError');
		const confirmPasswordError = document.getElementById('confirmPasswordError');

		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		const passwordRegex = /^(?=.*[A-Z])(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;

		let isEmailDuplicate = false; // 중복 여부 저장

		async function validateEmail() {
			const email = emailInput.value.trim();

			if (email === '') {
				emailError.textContent = '이메일을 입력해주세요.';
				emailError.style.display = 'block';
				isEmailDuplicate = false;
				return false;
			} else if (!emailRegex.test(email)) {
				emailError.textContent = '올바른 이메일 형식을 입력해주세요.';
				emailError.style.display = 'block';
				isEmailDuplicate = false;
				return false;
			} else {
				// 이메일 형식은 맞음 → 중복 체크 시작
				try {
					const res = await fetch(`/check-email?email=${encodeURIComponent(email)}`);
					const data = await res.json();

					if (data.duplicate) {
						emailError.textContent = '이미 사용 중인 이메일입니다.';
						emailError.style.display = 'block';
						isEmailDuplicate = true;
						return false;
					} else {
						emailError.style.display = 'none';
						isEmailDuplicate = false;
						return true;
					}
				} catch (err) {
					console.error('중복 검사 실패:', err);
					emailError.textContent = '이메일 중복 확인 중 오류가 발생했습니다.';
					emailError.style.display = 'block';
					isEmailDuplicate = true;
					return false;
				}
			}
		}

		function validatePassword() {
			const password = passwordInput.value.trim();
			if (!passwordRegex.test(password)) {
				passwordError.style.display = 'block';
				return false;
			} else {
				passwordError.style.display = 'none';
				return true;
			}
		}

		function validateConfirmPassword() {
			const password = passwordInput.value.trim();
			const confirmPassword = confirmPasswordInput.value.trim();

			if (password !== confirmPassword || confirmPassword === '') {
				confirmPasswordError.style.display = 'block';
				return false;
			} else {
				confirmPasswordError.style.display = 'none';
				return true;
			}
		}

		// 실시간 유효성 검사 (form 전송과 무관)
		emailInput.addEventListener('input', validateEmail);
		passwordInput.addEventListener('input', validatePassword);
		confirmPasswordInput.addEventListener('input', validateConfirmPassword);
		passwordInput.addEventListener('focus', validateEmail);

		// 폼 제출 시 검사 (여기서만 실제 제출 여부 결정)
		document.getElementById('signupForm').addEventListener('submit', async function (e) {
			e.preventDefault(); // 항상 막고, 모든 검사 통과 시에만 수동 제출

			const isEmailValid = await validateEmail();
			const isPasswordValid = validatePassword();
			const isConfirmPasswordValid = validateConfirmPassword();

			if (!isEmailValid) {
				emailInput.focus();
				return;
			}
			if (!isPasswordValid) {
				passwordInput.focus();
				return;
			}
			if (!isConfirmPasswordValid) {
				confirmPasswordInput.focus();
				return;
			}

			e.target.submit();
		});
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>