<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ê²¬ì  ê´€ë¦¬</title>
    <link th:href="@{/css/quotationBoard/quotation-myrequest.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/header.css}" rel="stylesheet" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link th:href="@{/css/footer.css}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" th:href="@{/css/chat/notification-system.css}" />
    <link rel="stylesheet" th:href="@{/css/quotationBoard/quotation-detail.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            margin-top: 100px;
        }

        section {
            min-height: 600px; /* ìµœì†Œ ë†’ì´ë¡œ ë³€ê²½ */
        }



    </style>
</head>
<body>
<div th:replace="~{header :: header}"></div>
<div class="container">
    <!-- ì¢Œì¸¡ ê²¬ì  ëª©ë¡ ì˜ì—­ -->
    <div class="quote-section">
        <!-- ìƒíƒœ íƒ­ -->
        <div class="quote-tabs">
            <button class="tab active" data-status="pending" onclick="loadQuotesByStatus('pending')">
                ì§„í–‰ì „
            </button>
            <button class="tab" data-status="progress" onclick="loadQuotesByStatus('progress')">
                ì§„í–‰ì¤‘
            </button>
            <button class="tab" data-status="completed" onclick="loadQuotesByStatus('completed')">
                ì™„ë£Œ
            </button>
        </div>

        <!-- ê²¬ì  ëª©ë¡ -->
        <div class="quote-list" id="quoteList">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
    </div>

    <!-- ìš°ì¸¡ ìƒì„¸ë³´ê¸° ì˜ì—­ -->
    <div class="chat-section">

        <div class="chat-content" id="chatContent">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-text">ê²¬ì  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="empty-subtext">ì¢Œì¸¡ ê²¬ì  ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ê²¬ì ì˜ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
        </div>
    </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ê²¬ì  ì‚­ì œ í™•ì¸</div>
        <div class="modal-body">
            ì •ë§ë¡œ ì´ ê²¬ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            <strong>ì‚­ì œëœ ê²¬ì ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>
        </div>
        <div class="modal-buttons">
            <button class="modal-button cancel" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
            <button class="modal-button confirm" onclick="confirmDelete()">ì‚­ì œ</button>
        </div>
    </div>
</div>

<script>
    // í˜„ì¬ ì„ íƒëœ ìƒíƒœì™€ ê²¬ì 
    let currentStatus = 'pending';
    let selectedPostId = null;
    let deleteTargetPostId = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        // ì´ˆê¸° ê²¬ì  ëª©ë¡ ë¡œë“œ
        loadQuotesByStatus('pending');
    });

    // ìƒíƒœë³„ ê²¬ì  ëª©ë¡ ë¡œë“œ
    function loadQuotesByStatus(status) {
        currentStatus = status;

        // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-status="${status}"]`).classList.add('active');

        // ë¡œë”© í‘œì‹œ
        const quoteList = document.getElementById('quoteList');
        quoteList.innerHTML = '<div class="loading"><div class="spinner"></div>ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetch(`/user/quotationBoard/api/myrequest?status=${status}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Loaded quotes:', data);
                renderQuoteList(data);
            })
            .catch(error => {
                console.error('Error loading quotes:', error);
                quoteList.innerHTML = `
                    <div class="error">
                        <div class="error-icon">âŒ</div>
                        <div class="empty-text">ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtext">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div>
                    </div>
                `;
            });
    }

    // ê²¬ì  ëª©ë¡ ë Œë”ë§
    function renderQuoteList(quotes) {
        const quoteList = document.getElementById('quoteList');

        if (!quotes || quotes.length === 0) {
            quoteList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">í•´ë‹¹ ìƒíƒœì˜ ì˜ë¢°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    <div class="empty-subtext">ìƒˆë¡œìš´ ê²¬ì  ì˜ë¢°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”</div>
                </div>
            `;
            // ìƒì„¸ë³´ê¸° ì˜ì—­ ì´ˆê¸°í™”
            resetDetailArea();
            return;
        }

        const statusClass = {
            pending: 'status-pending',
            progress: 'status-progress',
            completed: 'status-completed'
        };

        const statusText = {
            pending: 'ì§„í–‰ì „',
            progress: 'ì§„í–‰ì¤‘',
            completed: 'ì™„ë£Œ'
        };

        // ê²¬ì  ëª©ë¡ HTML ìƒì„±
        quoteList.innerHTML = quotes.map((quote, index) => {
            // ë‚ ì§œ í¬ë§·íŒ… (ì„œë²„ì—ì„œ ë°›ì€ ë‚ ì§œ í˜•ì‹ì— ë”°ë¼ ì¡°ì • í•„ìš”)
            const formattedDate = formatDate(quote.createdAt || quote.created_at);
            const postId = quote.postId || quote.post_id || quote.id;

            // ì§€ì •ê²¬ì  ìš”ì²­ ì—¬ë¶€ í™•ì¸
            const isExpertRequest = quote.expertId && quote.expertId !== null && quote.state === 'ì§„í–‰ì „';
            console.log("quote",quote.state)
            const expertClass = isExpertRequest ? 'expert-request' : '';

            // ì§€ì •ê²¬ì  ë°°ì§€
            const expertBadge = isExpertRequest ?
                '<span class="expert-badge"><i class="fas fa-star"></i>ì§€ì •ê²¬ì </span>' : '';

            return `
                <div class="quote-item ${expertClass} ${index === 0 ? 'active' : ''}"
                     data-post-id="${postId}"
                     onclick="selectQuote(this, ${postId})">
                    <div class="quote-header">
                        <div class="quote-title">
                            ${escapeHtml(quote.title)}
                            ${expertBadge}
                        </div>
                    </div>
                    <div class="quote-meta">
                        <div class="quote-category">${escapeHtml(quote.categoryName || quote.name || 'ì¹´í…Œê³ ë¦¬')}</div>
                        <div class="quote-date">${formattedDate}</div>
                    </div>
                    <div class="quote-preview">${escapeHtml(truncateText(quote.content || quote.description || '', 100))}</div>
                </div>
            `;
        }).join('');

        // ì²« ë²ˆì§¸ ê²¬ì  ìë™ ì„ íƒ
        if (quotes.length > 0) {
            const firstQuote = quotes[0];
            selectQuote(quoteList.querySelector('.quote-item'), firstQuote.postId || firstQuote.post_id || firstQuote.id);
        }
    }

    // ê²¬ì  ì„ íƒ
    function selectQuote(element, postId) {
        // ì´ì „ ì„ íƒ ì œê±°
        document.querySelectorAll('.quote-item').forEach(item => {
            item.classList.remove('active');
        });

        // ìƒˆë¡œìš´ ì„ íƒ ì¶”ê°€
        element.classList.add('active');
        selectedPostId = postId;

        // ê²¬ì  ìƒì„¸ ì •ë³´ ë¡œë“œ
        loadQuoteDetail(postId);
    }

    // ê²¬ì  ìƒì„¸ ì •ë³´ ë Œë”ë§ (ì²¨ë¶€íŒŒì¼ í¬í•¨) - ìˆ˜ì •ëœ ë²„ì „
    function renderQuoteDetail(data) {
        const chatContent = document.getElementById('chatContent');

        // ì§€ì •ê²¬ì  ìš”ì²­ ì—¬ë¶€ í™•ì¸
        const isExpertRequest = data.expertId && data.expertId !== null && data.state==='ì§„í–‰ì „';
        const expertBadge = isExpertRequest ?
            '<span class="expert-badge"><i class="fas fa-star"></i>ì§€ì •ê²¬ì  ìš”ì²­</span>' : '';

        // ì§„í–‰ì „ ìƒíƒœì¼ ë•Œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ (ì¹´ë“œ ë³¸ë¬¸ ë‚´ë¶€ë¡œ ì´ë™)
        const deleteButton = currentStatus === 'pending' ?
            `<button class="delete-button-content" onclick="showDeleteModal(event, ${data.postId})" title="ê²¬ì  ì‚­ì œ">
            <i class="fas fa-trash"></i>ì‚­ì œ
        </button>` : '';

        // 1) ì²¨ë¶€íŒŒì¼ HTML ìƒì„±
        let attachedFilesHtml = '';
        if (data.attachedFiles && data.attachedFiles.length > 0) {
            attachedFilesHtml = `
      <div class="content-section">
        <h3 class="section-title">
          <i class="fas fa-paperclip"></i> ì²¨ë¶€íŒŒì¼
        </h3>
        <ul class="file-list">
          ${data.attachedFiles.map(file => `
            <li class="file-item">
              <span class="file-link"
                    onclick="previewFile('${file.path}')">
                ${escapeHtml(file.name)}
              </span>
              <a href="/user/quotationBoard/download/${file.attachedFileId}"
                 class="download-btn">
                <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
              </a>
            </li>
          `).join('')}
        </ul>
      </div>`;
        }

        // 2) ì „ì²´ ìƒì„¸ ë·° ë§ˆí¬ì—… (ì‚­ì œ ë²„íŠ¼ì„ ì¹´ë“œ ë³¸ë¬¸ìœ¼ë¡œ ì´ë™)
        const detailHtml = `
    <div class="detail-view">
      <div class="quotation-card">
        <div class="card-header">
          <h1 class="quotation-title">
            ${escapeHtml(data.title)}
            ${expertBadge}
          </h1>
          <button class="chat-room-list-btn"
                  onclick="openChatRooms(${data.postId})">
            <i class="fas fa-comments"></i> ì±„íŒ… ëŒ€í™”ë°© ì…ì¥
          </button>
        </div>
        <div class="card-body">
          ${deleteButton}
          <div class="content-section">
            <h3 class="section-title">
              <i class="fas fa-tags"></i> ì¹´í…Œê³ ë¦¬
            </h3>
            <div class="category-item">
              ${escapeHtml(data.categoryName)}
            </div>
          </div>
          <div class="content-section">
            <h3 class="section-title">
              <i class="fas fa-map-marker-alt"></i> ì˜ë¢° ì§€ì—­
            </h3>
            <ul class="location-list">
              ${data.quotationLocations.map(loc => `
                <li class="location-item">
                  <i class="fas fa-map-pin"></i>
                  <span>${escapeHtml(loc.city)} ${escapeHtml(loc.district)}</span>
                </li>
              `).join('')}
            </ul>
          </div>
          <div class="content-section">
            <h3 class="section-title">
              <i class="fas fa-file-alt"></i> ìš”ì²­ ë‚´ìš©
            </h3>
            <div class="content-text">${data.content || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
          </div>
          ${attachedFilesHtml}
        </div>
      </div>
    </div>`;

        chatContent.innerHTML = detailHtml;
    }

    // ê²¬ì  ìƒì„¸ ì •ë³´ ë¡œë“œ
    function loadQuoteDetail(postId) {
        const chatContent = document.getElementById('chatContent');

        // 1) ë¡œë”© í‘œì‹œ
        chatContent.innerHTML = '<div class="loading"><div class="spinner"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

        // 2) ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetch(`/user/quotationBoard/api/detail/${postId}`)
            .then(res => {
                if (!res.ok) throw new Error(res.status);
                return res.json();
            })
            .then(data => {
                console.log('Loaded quote detail:', data);
                // renderQuoteDetailì—ì„œ ìƒì„¸ + ì²¨ë¶€íŒŒì¼ ë Œë”ë§
                renderQuoteDetail(data);
            })
            .catch(err => {
                console.error('Error loading quote detail:', err);
                chatContent.innerHTML = `
        <div class="error">
          <div class="error-icon">âŒ</div>
          <div class="empty-text">ê²¬ì  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
          <div class="empty-subtext">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div>
        </div>`;
            });
    }

    // ìƒˆì°½ì—ì„œ ì±„íŒ…ë°© ëª©ë¡ ì—´ê¸°
    function openChatRooms(postId) {
        const chatRoomUrl = `/chat/${postId}/rooms`;
        window.open(chatRoomUrl, 'chatRooms', 'width=1000,height=700,scrollbars=yes,resizable=yes');
    }

    // ì‚­ì œ ëª¨ë‹¬ í‘œì‹œ
    function showDeleteModal(event, postId) {
        event.stopPropagation(); // ê²¬ì  ì„ íƒ ì´ë²¤íŠ¸ ë°©ì§€
        deleteTargetPostId = postId;
        console.log('deleteTargetPostId:', deleteTargetPostId);
        document.getElementById('deleteModal').style.display = 'block';
    }

    // ì‚­ì œ ëª¨ë‹¬ ë‹«ê¸°
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        deleteTargetPostId = null;
    }

    // ì‚­ì œ í™•ì¸ (ìˆ˜ì •ëœ ë²„ì „)
    function confirmDelete() {
        if (!deleteTargetPostId) {
            console.error('deleteTargetPostIdê°€ ì—†ìŠµë‹ˆë‹¤.');
            alert('ì‚­ì œí•  ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const requestUrl = `/user/quotationBoard/api/delete/${deleteTargetPostId}`;
        console.log('ì‚­ì œ ìš”ì²­ ì‹œì‘ - postId:', deleteTargetPostId);
        console.log('ìš”ì²­ URL:', requestUrl);
        console.log('í˜„ì¬ í˜ì´ì§€ URL:', window.location.href);

        // ì‚­ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
        const confirmBtn = document.querySelector('.modal-button.confirm');
        const originalText = confirmBtn.textContent;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'ì‚­ì œ ì¤‘...';

        // ì‚­ì œ API í˜¸ì¶œ - DELETE ë©”ì„œë“œ ì‚¬ìš©
        console.log('fetch ìš”ì²­ ì „ì†¡ ì¤‘...');
        fetch(requestUrl, {
            method: 'GET',  // DELETE ë©”ì„œë“œë¡œ ë³€ê²½
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(response => {
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                console.log('ì‘ë‹µ Content-Type:', response.headers.get('content-type'));

                // ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ 204 No Contentì¸ ê²½ìš° ì²˜ë¦¬
                if (response.status === 204 || response.status === 200) {
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json();
                    } else {
                        // JSONì´ ì•„ë‹Œ ê²½ìš° ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                        return { success: true, message: 'ê²¬ì ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' };
                    }
                } else if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                } else {
                    return response.json();
                }
            })
            .then(data => {
                console.log('Delete success:', data);
                // ëª¨ë‹¬ ë‹«ê¸°
                closeDeleteModal();
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadQuotesByStatus(currentStatus);
                // ì„±ê³µ ë©”ì‹œì§€
                alert('ê²¬ì ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            })
            .catch(error => {
                console.error('Error deleting quote:', error);
                alert('ê²¬ì  ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + error.message);
            })
            .finally(() => {
                // ì‚­ì œ ë²„íŠ¼ ë³µì›
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            });
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target === modal) {
            closeDeleteModal();
        }
    }

    // ìƒì„¸ë³´ê¸° ì˜ì—­ ì´ˆê¸°í™”
    function resetDetailArea() {
        const chatHeader = document.getElementById('chatHeader');
        const chatContent = document.getElementById('chatContent');

        chatContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-text">ê²¬ì  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="empty-subtext">ì¢Œì¸¡ ê²¬ì  ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ê²¬ì ì˜ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
        `;
    }

    // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
    function previewFile(filepath) {
        // ìƒˆ ì°½ì—ì„œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì˜ˆì‹œ)
        window.open(filepath, 'preview', 'width=800,height=600');
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function formatDate(dateString) {
        if (!dateString) return '';

        try {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        } catch (error) {
            console.error('Date formatting error:', error);
            return dateString;
        }
    }

    function formatDateTime(dateString) {
        if (!dateString) return '';

        try {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (error) {
            console.error('DateTime formatting error:', error);
            return dateString;
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
</script>
<div th:replace="~{footer :: footer}"></div>
</body>
</html>