<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>견적 요청 작성</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 선택된 지역 배지 스타일 */
        .selected-item {
            display: inline-flex;
            align-items: center;
            background-color: #0d6efd;
            color: #fff;
            border-radius: .25rem;
            padding: .25rem .5rem;
            margin-right: .5rem;
            margin-bottom: .5rem;
            font-size: .875rem;
            transition: background-color .2s;
        }
        .selected-item:hover {
            background-color: #0b5ed7;
        }
        .selected-item span.remove {
            margin-left: .5rem;
            cursor: pointer;
            font-weight: bold;
        }
        /* 구/군 버튼 애니메이션 */
        .district-option {
            transition: transform .1s, background-color .2s;
        }
        .district-option:hover {
            transform: scale(1.05);
            background-color: #e2e6ea;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>견적 요청 작성</h2>
    <form th:action="@{/user/quotationBoard/create}" th:object="${quotationBoard}" method="post" enctype="multipart/form-data">

        <!-- 상태를 '진행전' 으로 기본값 설정 -->
        <input type="hidden" th:field="*{state}" th:value="'진행전'"/>

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" th:field="*{title}" id="title" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea th:field="*{content}" id="content" class="form-control" rows="5" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">카테고리</label>
            <select th:field="*{categoryId}" class="form-select" required>
                <option th:each="cat : ${categories}" th:value="${cat.categoryId}" th:text="${cat.name}">카테고리명</option>
            </select>
        </div>

        <!-- 지역 선택 UI -->
        <div class="mb-3">
            <label class="form-label">위치</label>
            <!-- 선택된 지역 배지 표시 -->
            <div id="selectedLocations" class="mb-2"></div>
            <!-- 도시 선택 드롭다운 -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <select id="citySelect" class="form-select">
                        <option value="">--도시 선택--</option>
                        <option th:each="loc : ${locations}" th:value="${loc.city}" th:text="${loc.city} + '시'"></option>
                    </select>
                </div>
                <!-- 구/군 버튼 리스트 -->
                <div class="col-md-6">
                    <div id="districtButtons" class="d-flex flex-wrap"></div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="attachedFiles" class="form-label">첨부파일</label>
            <input class="form-control" type="file" id="attachedFiles" name="attachedFiles" multiple>
        </div>

        <button type="submit" class="btn btn-primary">등록</button>
        <a th:href="@{/user/quotationBoard/list}" class="btn btn-secondary">취소</a>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const locations = /*[[${locations}]]*/ [];
    const citySelect = document.getElementById('citySelect');
    const districtButtons = document.getElementById('districtButtons');
    const selectedContainer = document.getElementById('selectedLocations');
    const selectedIds = new Set();

    citySelect.addEventListener('change', () => {
        const city = citySelect.value;
        districtButtons.innerHTML = '';
        if (!city) return;
        locations.filter(loc => loc.city === city)
            .forEach(loc => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'district-option btn btn-outline-secondary me-2 mb-2';
                btn.textContent = loc.district;
                btn.dataset.id = loc.locationId;
                btn.dataset.city = loc.city;
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    if (selectedIds.has(id)) return;
                    selectedIds.add(id);
                    const span = document.createElement('span');
                    span.className = 'selected-item';
                    span.textContent = btn.dataset.city + '시 ' + btn.textContent;
                    const remove = document.createElement('span');
                    remove.className = 'remove';
                    remove.textContent = '×';
                    remove.addEventListener('click', () => {
                        selectedIds.delete(id);
                        span.remove();
                    });
                    span.appendChild(remove);
                    // hidden input
                    const input = document.createElement('input');
                    input.type = 'hidden'; input.name = 'locationIds'; input.value = id;
                    selectedContainer.appendChild(span);
                    selectedContainer.appendChild(input);
                });
                districtButtons.appendChild(btn);
            });
    });
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>