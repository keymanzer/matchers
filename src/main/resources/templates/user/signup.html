<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>회원가입</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" th:href="@{/css/header.css}" />
	<style>
		.wrapper {
			background-color: #f8f9fa;
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh;
		}

		.signup-card {
			width: 100%;
			max-width: 400px;
			border: none;
			border-radius: 16px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
		}

		.signup-card .card-header {
			background-color: white;
			text-align: center;
			border-bottom: none;
			padding-top: 24px;
		}

		.signup-card .card-header h4 {
			font-weight: 700;
			font-size: 1.5rem;
		}

		.signup-card .card-body {
			padding: 2rem;
		}

		.form-control {
			border-radius: 12px;
			font-size: 0.95rem;
		}

		.btn-primary {
			background-color: #6b48ff;
			border: none;
			border-radius: 12px;
			font-weight: 600;
			font-size: 1rem;
		}

		.btn-primary:hover {
			background-color: #5838dd;
		}

		.error-message {
			font-size: 0.85rem;
			color: red;
			display: none;
			margin-top: 4px;
		}

		.reset-link {
			font-size: 0.85rem;
			color: #6c757d;
			text-decoration: none;
		}

		.reset-link:hover {
			text-decoration: underline;
		}
	</style>

</head>

<body>
	<div class="wrapper">
		<div th:replace="~{header :: header}"></div>
		<div class="card signup-card">
			<div class="card-header">
				<h4>회원가입</h4>
			</div>
			<div class="card-body">
				<form id="signupForm" action="/signup" method="post">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

					<div class="mb-3">
						<input type="text" class="form-control" id="email" name="email" placeholder="이메일을 입력하세요">
						<div class="error-message" id="emailError">이메일을 입력해주세요.</div>
					</div>

					<div class="mb-3">
						<input type="password" class="form-control" id="password" name="password"
							placeholder="비밀번호를 입력하세요">
						<div class="error-message" id="passwordError">
							비밀번호는 8자 이상, 대문자 1개 이상, 특수기호를 포함해야 합니다.
						</div>
					</div>

					<div class="mb-4">
						<input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
							placeholder="비밀번호 확인">
						<div class="error-message" id="confirmPasswordError">비밀번호가 일치하지 않습니다.</div>
					</div>

					<div class="d-grid mb-3">
						<button type="submit" class="btn btn-primary">이메일로 가입하기</button>
					</div>

					<div class="text-center">
						<a href="/login" class="reset-link">이미 계정이 있으신가요? 로그인</a>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		const emailInput = document.getElementById('email');
		const passwordInput = document.getElementById('password');
		const confirmPasswordInput = document.getElementById('confirmPassword');

		const emailError = document.getElementById('emailError');
		const passwordError = document.getElementById('passwordError');
		const confirmPasswordError = document.getElementById('confirmPasswordError');

		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		const passwordRegex = /^(?=.*[A-Z])(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;

		let isEmailDuplicate = false;

		async function validateEmail() {
			const email = emailInput.value.trim();

			if (email === '') {
				emailError.textContent = '이메일을 입력해주세요.';
				emailError.style.display = 'block';
				return false;
			} else if (!emailRegex.test(email)) {
				emailError.textContent = '올바른 이메일 형식을 입력해주세요.';
				emailError.style.display = 'block';
				return false;
			} else {
				try {
					const res = await fetch(`/check-email?email=${encodeURIComponent(email)}`);
					const data = await res.json();

					if (data.duplicate) {
						emailError.textContent = '이미 사용 중인 이메일입니다.';
						emailError.style.display = 'block';
						return false;
					} else {
						emailError.style.display = 'none';
						return true;
					}
				} catch (err) {
					emailError.textContent = '이메일 확인 중 오류가 발생했습니다.';
					emailError.style.display = 'block';
					return false;
				}
			}
		}

		function validatePassword() {
			const password = passwordInput.value.trim();
			if (!passwordRegex.test(password)) {
				passwordError.style.display = 'block';
				return false;
			} else {
				passwordError.style.display = 'none';
				return true;
			}
		}

		function validateConfirmPassword() {
			const password = passwordInput.value.trim();
			const confirmPassword = confirmPasswordInput.value.trim();
			if (password !== confirmPassword || confirmPassword === '') {
				confirmPasswordError.style.display = 'block';
				return false;
			} else {
				confirmPasswordError.style.display = 'none';
				return true;
			}
		}

		emailInput.addEventListener('input', validateEmail);
		passwordInput.addEventListener('input', validatePassword);
		confirmPasswordInput.addEventListener('input', validateConfirmPassword);

		document.getElementById('signupForm').addEventListener('submit', async function (e) {
			e.preventDefault();
			const isEmailValid = await validateEmail();
			const isPasswordValid = validatePassword();
			const isConfirmPasswordValid = validateConfirmPassword();

			if (isEmailValid && isPasswordValid && isConfirmPasswordValid) {
				e.target.submit();
			}
		});
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>