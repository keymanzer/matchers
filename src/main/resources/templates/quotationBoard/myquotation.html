<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ê²¬ì  ê´€ë¦¬</title>
    <link th:href="@{/css/quotationBoard/quotation-myquotation.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/header.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/footer.css}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" th:href="@{/css/chat/notification-system.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            margin-top: 100px;
        }

        section {
            min-height: 600px; /* ìµœì†Œ ë†’ì´ë¡œ ë³€ê²½ */
        }
    </style>
</head>
<body>
<div th:replace="~{header :: header}"></div>
<div class="container">
    <!-- ì¢Œì¸¡ ê²¬ì  ëª©ë¡ ì˜ì—­ -->
    <div class="quote-section">
        <!-- ìƒíƒœ íƒ­ -->
        <div class="quote-tabs">
            <button class="tab active" data-status="pending" onclick="loadQuotesByStatus('pending')">
                ì§„í–‰ì „
            </button>
            <button class="tab" data-status="progress" onclick="loadQuotesByStatus('progress')">
                ì§„í–‰ì¤‘
            </button>
            <button class="tab" data-status="completed" onclick="loadQuotesByStatus('completed')">
                ì™„ë£Œ
            </button>
        </div>

        <!-- ê²¬ì  ëª©ë¡ -->
        <div class="quote-list" id="quoteList">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
    </div>

    <!-- ìš°ì¸¡ ì±„íŒ… ì˜ì—­ -->
    <div class="chat-section">
        <div class="chat-header" id="chatHeader">
            <div class="chat-title">ë¹„ë™ê¸° ì±„íŒ… ë‚´ì—­</div>
            <div class="chat-subtitle">ê²¬ì ì„ ì„ íƒí•˜ë©´ ì±„íŒ… ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>

        <div class="chat-content" id="chatContent">
            <div class="empty-state">
                <div class="empty-icon">ğŸ’¬</div>
                <div class="empty-text">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="empty-subtext">ì¢Œì¸¡ ê²¬ì  ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ì±„íŒ… ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
        </div>
    </div>
</div>

<script>
    // í˜„ì¬ ì„ íƒëœ ìƒíƒœì™€ ê²¬ì 
    let currentStatus = 'pending';
    let selectedPostId = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        // ì´ˆê¸° ê²¬ì  ëª©ë¡ ë¡œë“œ
        loadQuotesByStatus('pending');
    });

    // ìƒíƒœë³„ ê²¬ì  ëª©ë¡ ë¡œë“œ
    function loadQuotesByStatus(status) {
        currentStatus = status;

        // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-status="${status}"]`).classList.add('active');

        // ë¡œë”© í‘œì‹œ
        const quoteList = document.getElementById('quoteList');
        quoteList.innerHTML = '<div class="loading"><div class="spinner"></div>ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetch(`/user/quotationBoard/api/myquotation?status=${status}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Loaded quotes:', data);
                renderQuoteList(data);
            })
            .catch(error => {
                console.error('Error loading quotes:', error);
                quoteList.innerHTML = `
                    <div class="error">
                        <div class="error-icon">âŒ</div>
                        <div class="empty-text">ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtext">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div>
                    </div>
                `;
            });
    }

    // ê²¬ì  ëª©ë¡ ë Œë”ë§
    function renderQuoteList(quotes) {
        const quoteList = document.getElementById('quoteList');

        if (!quotes || quotes.length === 0) {
            quoteList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">í•´ë‹¹ ìƒíƒœì˜ ê²¬ì ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-subtext">ìƒˆë¡œìš´ ê²¬ì  ìš”ì²­ì„ ì‘ì„±í•´ë³´ì„¸ìš”</div>
                </div>
            `;
            // ì±„íŒ… ì˜ì—­ ì´ˆê¸°í™”
            resetChatArea();
            return;
        }

        const statusClass = {
            pending: 'status-pending',
            progress: 'status-progress',
            completed: 'status-completed'
        };

        const statusText = {
            pending: 'ì§„í–‰ì „',
            progress: 'ì§„í–‰ì¤‘',
            completed: 'ì™„ë£Œ'
        };

        // ê²¬ì  ëª©ë¡ HTML ìƒì„±
        quoteList.innerHTML = quotes.map((quote, index) => {
            // ë‚ ì§œ í¬ë§·íŒ… (ì„œë²„ì—ì„œ ë°›ì€ ë‚ ì§œ í˜•ì‹ì— ë”°ë¼ ì¡°ì • í•„ìš”)
            const formattedDate = formatDate(quote.createdAt || quote.created_at);
            const postId = quote.postId || quote.post_id || quote.id;

            const actionButtons = `
                <div class="action-buttons">
                    <button class="action-button detail-button" onclick="openQuoteDetail(event, ${postId})" title="ìƒì„¸ë³´ê¸°">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            `;



            return `
                <div class="quote-item ${index === 0 ? 'active' : ''}"
                    data-post-id="${postId}"
                     onclick="selectQuote(this, ${postId})">
                    ${actionButtons}
                    <div class="quote-header">
                        <div class="quote-title">${escapeHtml(quote.title)}</div>

                    </div>
                    <div class="quote-meta">
                        <div class="quote-expert">${escapeHtml(quote.expertName || quote.expert_name || 'ì „ë¬¸ê°€')}</div>
                        <div class="quote-category">${escapeHtml(quote.categoryName || quote.category_name || 'ì¹´í…Œê³ ë¦¬')}</div>
                        <div class="quote-date">${formattedDate}</div>
                    </div>
                    <div class="quote-preview">${escapeHtml(truncateText(quote.content || quote.description || '', 100))}</div>
                </div>
            `;
        }).join('');

        // ì²« ë²ˆì§¸ ê²¬ì  ìë™ ì„ íƒ
        if (quotes.length > 0) {
            const firstQuote = quotes[0];
            selectQuote(quoteList.querySelector('.quote-item'), firstQuote.postId || firstQuote.post_id || firstQuote.id);
        }
    }

    // ê²¬ì  ì„ íƒ
    function selectQuote(element, postId) {
        // ì´ì „ ì„ íƒ ì œê±°
        document.querySelectorAll('.quote-item').forEach(item => {
            item.classList.remove('active');
        });

        // ìƒˆë¡œìš´ ì„ íƒ ì¶”ê°€
        element.classList.add('active');
        selectedPostId = postId;

        // ì±„íŒ… ë‚´ì—­ ë¡œë“œ
        loadChatHistory(postId);
    }

    // ìƒì„¸ë³´ê¸° ìƒˆì°½ ì—´ê¸°
    function openQuoteDetail(event, postId) {
        event.stopPropagation(); // ê²¬ì  ì„ íƒ ì´ë²¤íŠ¸ ë°©ì§€

        console.log('ìƒì„¸ë³´ê¸° ì—´ê¸° - postId:', postId);

        // ìƒˆì°½ìœ¼ë¡œ ìƒì„¸ë³´ê¸° í˜ì´ì§€ ì—´ê¸°
        const detailUrl = `/user/quotationBoard/list/${postId}`;
        const windowFeatures = 'width=1000,height=700,scrollbars=yes,resizable=yes,left=100,top=100';

        window.open(detailUrl, `quote_detail_${postId}`, windowFeatures);
    }

    // ì±„íŒ… ë‚´ì—­ ë¡œë“œ
    function loadChatHistory(postId) {
        const chatHeader = document.getElementById('chatHeader');
        const chatContent = document.getElementById('chatContent');

        // í—¤ë” ì—…ë°ì´íŠ¸
        const selectedQuote = document.querySelector(`[data-post-id="${postId}"]`);
        const quoteTitle = selectedQuote.querySelector('.quote-title').textContent;
        const quoteExpert = selectedQuote.querySelector('.quote-expert').textContent;

        chatHeader.innerHTML = `
            <div class="chat-title">${quoteTitle}</div>
            <div class="chat-subtitle">${quoteExpert}ê³¼ì˜ ì±„íŒ…</div>
        `;

        // ë¡œë”© í‘œì‹œ
        chatContent.innerHTML = '<div class="loading"><div class="spinner"></div>ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        // ì±„íŒ… ë‚´ì—­ API í˜¸ì¶œ (êµ¬í˜„ ì˜ˆì •)
        // ì‹¤ì œ ì±„íŒ… APIê°€ êµ¬í˜„ë˜ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê³  ì‚¬ìš©
        /*
        fetch(`/user/quotationBoard/api/chat/${postId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                renderChatHistory(data);
            })
            .catch(error => {
                console.error('Error loading chat:', error);
                chatContent.innerHTML = `
                    <div class="error">
                        <div class="error-icon">âŒ</div>
                        <div class="empty-text">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtext">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div>
                    </div>
                `;
            });
        */

        // ì„ì‹œë¡œ êµ¬í˜„ ì˜ˆì • ë©”ì‹œì§€ í‘œì‹œ
        setTimeout(() => {
            chatContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸš§</div>
                    <div class="empty-text">ì±„íŒ… ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •</div>
                    <div class="empty-subtext">Post ID: ${postId}ë¡œ ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ì˜ˆì •ì…ë‹ˆë‹¤</div>
                </div>
            `;
        }, 800);
    }

    // ì±„íŒ… ì˜ì—­ ì´ˆê¸°í™”
    function resetChatArea() {
        const chatHeader = document.getElementById('chatHeader');
        const chatContent = document.getElementById('chatContent');

        chatHeader.innerHTML = `
            <div class="chat-title">ë¹„ë™ê¸° ì±„íŒ… ë‚´ì—­</div>
            <div class="chat-subtitle">ê²¬ì ì„ ì„ íƒí•˜ë©´ ì±„íŒ… ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
        `;

        chatContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ’¬</div>
                <div class="empty-text">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="empty-subtext">ì¢Œì¸¡ ê²¬ì  ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ì±„íŒ… ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
        `;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function formatDate(dateString) {
        if (!dateString) return '';

        try {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        } catch (error) {
            console.error('Date formatting error:', error);
            return dateString;
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
</script>
<div th:replace="~{footer :: footer}"></div>
</body>
</html>