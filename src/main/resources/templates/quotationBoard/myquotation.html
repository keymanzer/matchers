<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ê²¬ì  ê´€ë¦¬</title>
    <link th:href="@{/css/quotationBoard/quotation-myquotation.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/header.css}" rel="stylesheet" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link th:href="@{/css/footer.css}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" th:href="@{/css/chat/notification-system.css}" />
    <link rel="stylesheet" th:href="@{/css/quotationBoard/quotation-detail.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin-top: 100px;
        }
        section {
            min-height: 600px;
        }

    </style>
</head>
<body>
<div th:replace="~{header :: header}"></div>
<div class="container">
    <!-- ì¢Œì¸¡ ê²¬ì  ëª©ë¡ ì˜ì—­ -->
    <div class="quote-section">
        <div class="quote-tabs">
            <button class="tab active" data-status="pending" onclick="loadQuotesByStatus('pending')">ì§„í–‰ì „</button>
            <button class="tab" data-status="progress" onclick="loadQuotesByStatus('progress')">ì§„í–‰ì¤‘</button>
            <button class="tab" data-status="completed" onclick="loadQuotesByStatus('completed')">ì™„ë£Œ</button>
        </div>
        <div class="quote-list" id="quoteList">
            <div class="loading"><div class="spinner"></div>ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <!-- ìš°ì¸¡ ì±„íŒ… ì˜ì—­ -->
    <div class="chat-section">
        <div class="chat-content" id="chatContent">
            <div class="empty-state">
                <div class="empty-icon">ğŸ’¬</div>
                <div class="empty-text">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="empty-subtext">ì¢Œì¸¡ ê²¬ì  ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ìƒì„¸ ê²¬ì ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let currentStatus = 'pending';
    let selectedPostId = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadQuotesByStatus('pending');
    });

    // 1) ëª©ë¡ ë¡œë“œ
    function loadQuotesByStatus(status) {
        currentStatus = status;
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`[data-status="${status}"]`).classList.add('active');

        const quoteList = document.getElementById('quoteList');
        quoteList.innerHTML = '<div class="loading"><div class="spinner"></div>ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        fetch(`/user/quotationBoard/api/myquotation?status=${status}`)
            .then(res => {
                if (!res.ok) throw new Error(res.status);
                return res.json();
            })
            .then(data => renderQuoteList(data))
            .catch(err => {
                console.error('Error loading quotes:', err);
                quoteList.innerHTML = `
                    <div class="error">
                        <div class="error-icon">âŒ</div>
                        <div class="empty-text">ê²¬ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtext">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div>
                    </div>`;
            });
    }

    // 2) ëª©ë¡ ë Œë”ë§
    function renderQuoteList(quotes) {
        const quoteList = document.getElementById('quoteList');
        if (!quotes || quotes.length === 0) {
            quoteList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">í•´ë‹¹ ìƒíƒœì˜ ê²¬ì ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-subtext">ìƒˆë¡œìš´ ê²¬ì  ìš”ì²­ì„ ì‘ì„±í•´ë³´ì„¸ìš”</div>
                </div>`;
            resetChatArea();
            return;
        }

        quoteList.innerHTML = quotes.map((q, i) => {
            const date = formatDate(q.createdAt || q.created_at);
            const id = q.postId || q.post_id || q.id;
            return `
                <div class="quote-item ${i===0?'active':''}" data-post-id="${id}" onclick="selectQuote(this,${id})">
                    <div class="quote-meta">
                        <div class="quote-expert">${escapeHtml(q.expertName||q.expert_name||'ì „ë¬¸ê°€')}</div>
                        <div class="quote-category">${escapeHtml(q.categoryName||q.name||'ì¹´í…Œê³ ë¦¬')}</div>
                        <div class="quote-date">${date}</div>
                    </div>
                    <div class="quote-preview">${escapeHtml(truncateText(q.content||q.description||'',100))}</div>
                </div>`;
        }).join('');
        if (quotes.length>0) {
            const first = quoteList.querySelector('.quote-item');
            selectQuote(first, quotes[0].postId || quotes[0].post_id || quotes[0].id);
        }
    }

    // 3) í•­ëª© ì„ íƒ
    function selectQuote(el, postId) {
        document.querySelectorAll('.quote-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        selectedPostId = postId;
        loadQuoteDetail(postId);
    }

    // 4) ìƒì„¸ + ì²¨ë¶€íŒŒì¼ ë Œë”ë§ í•¨ìˆ˜
    function renderQuoteDetail(data) {
        const chatContent = document.getElementById('chatContent');

        // ì²¨ë¶€íŒŒì¼ HTML ìƒì„±
        let attachedFilesHtml = '';
        if (Array.isArray(data.attachedFiles) && data.attachedFiles.length>0) {
            attachedFilesHtml = `
            <div class="content-section">
              <h3 class="section-title"><i class="fas fa-paperclip"></i> ì²¨ë¶€íŒŒì¼</h3>
              <ul class="file-list">
                ${data.attachedFiles.map(f=>`
                  <li class="file-item">
                    <span class="file-link" onclick="previewFile('${f.path}')">${escapeHtml(f.name)}</span>
                    <a href="/user/quotationBoard/download/${f.attachedFileId}" class="download-btn">
                      <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
                    </a>
                  </li>`).join('')}
              </ul>
            </div>`;
        }

        // ì „ì²´ ìƒì„¸ë·° ë§ˆí¬ì—…
        const detailHtml = `
          <div class="detail-view">
            <div class="quotation-card">
              <div class="card-header">
                <h1 class="quotation-title">${escapeHtml(data.title)}</h1>
                <button class="chat-room-list-btn" onclick="openChatRooms(${data.postId})">
                  <i class="fas fa-comments"></i> ì±„íŒ… ëŒ€í™”ë°© ì…ì¥
                </button>
              </div>
              <div class="card-body">
                <div class="content-section">
                  <h3 class="section-title"><i class="fas fa-tags"></i> ì¹´í…Œê³ ë¦¬</h3>
                  <div class="category-item">${escapeHtml(data.categoryName)}</div>
                </div>
                <div class="content-section">
                  <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> ì˜ë¢° ì§€ì—­</h3>
                  <ul class="location-list">
                    ${data.quotationLocations.map(loc=>`
                      <li class="location-item">
                        <i class="fas fa-map-pin"></i>
                        <span>${escapeHtml(loc.city)} ${escapeHtml(loc.district)}</span>
                      </li>`).join('')}
                  </ul>
                </div>
                <div class="content-section">
                  <h3 class="section-title"><i class="fas fa-file-alt"></i> ìš”ì²­ ë‚´ìš©</h3>
                   <div class="content-text">${data.content || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                </div>
                ${attachedFilesHtml}
              </div>
            </div>
          </div>`;
        chatContent.innerHTML = detailHtml;
    }

    // 5) ìƒì„¸ ë¡œë“œ
    function loadQuoteDetail(postId) {
        const chatContent = document.getElementById('chatContent');
        chatContent.innerHTML = '<div class="loading"><div class="spinner"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
        fetch(`/user/quotationBoard/api/detail/${postId}`)
            .then(res=>{ if(!res.ok) throw new Error(res.status); return res.json() })
            .then(data=> renderQuoteDetail(data))
            .catch(err=>{
                console.error('Error loading quote detail:',err);
                chatContent.innerHTML = `
                  <div class="error">
                    <div class="error-icon">âŒ</div>
                    <div class="empty-text">ê²¬ì  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                    <div class="empty-subtext">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</div>
                  </div>`;
            });
    }

    // ê¸°íƒ€ í•¨ìˆ˜ë“¤
    function openChatRooms(postId) {
        window.open(`/chat/${postId}/rooms`, 'chatRooms','width=1000,height=700,scrollbars=yes,resizable=yes');
    }
    function resetChatArea() {
        const chatContent = document.getElementById('chatContent');
        chatContent.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <div class="empty-text">ë³´ì‹œì‹¶ì€ ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            <div class="empty-subtext">ì¢Œì¸¡ ê²¬ì  ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ìƒì„¸ ê²¬ì ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>`;
    }
    function previewFile(path) {
        window.open(path,'preview','width=800,height=600');
    }
    function formatDate(s) {
        if(!s) return '';
        const d=new Date(s), y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2);
        return `${y}-${m}-${day}`;
    }
    function escapeHtml(t) {
        if(!t) return '';
        const d=document.createElement('div'); d.textContent=t; return d.innerHTML;
    }
    function truncateText(t,n){ if(!t) return ''; return t.length<=n?t:t.slice(0,n)+'...'; }
</script>
<div th:replace="~{footer :: footer}"></div>
</body>
</html>
